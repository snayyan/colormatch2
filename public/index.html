<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColorMatch.io</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'bounce-short': 'bounce 0.5s ease-in-out 1',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <!-- Phosphor Icons for UI elements -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* Custom styling for sliders */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 12px;
            cursor: pointer;
            border-radius: 9999px;
            outline: none;
            transition: all .15s ease-in-out;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Disabled state for sliders */
        input[type=range]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            filter: grayscale(100%);
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ffffff;
            border: 2px solid currentColor;
            cursor: grab;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            transition: transform 0.1s;
        }

        input[type=range]:active::-webkit-slider-thumb {
            transform: scale(1.2);
            cursor: grabbing;
        }

        /* Remove spinners from number inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Specific tracks for R, G, B */
        #slider-r { background: linear-gradient(to right, #000000, #ff0000); }
        #slider-g { background: linear-gradient(to right, #000000, #00ff00); }
        #slider-b { background: linear-gradient(to right, #000000, #0000ff); }

        /* Confetti Canvas */
        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        /* --- Background Patterns --- */
        .pattern-dots {
            background-color: #fff1f2; /* rose-50 */
            background-image: radial-gradient(#fb7185 2px, transparent 2px);
            background-size: 24px 24px;
        }
        .pattern-grid {
            background-color: #eff6ff; /* blue-50 */
            background-image: linear-gradient(#93c5fd 1px, transparent 1px), linear-gradient(90deg, #93c5fd 1px, transparent 1px);
            background-size: 24px 24px;
        }
        .pattern-diagonal {
            background-color: #fff7ed; /* orange-50 */
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, #fdba74 10px, #fdba74 12px);
        }
        .pattern-zigzag {
            background-color: #f0fdfa; /* teal-50 */
            background-image:  linear-gradient(135deg, #5eead4 25%, transparent 25%), linear-gradient(225deg, #5eead4 25%, transparent 25%), linear-gradient(45deg, #5eead4 25%, transparent 25%), linear-gradient(315deg, #5eead4 25%, transparent 25%);
            background-position:  10px 0, 10px 0, 0 0, 0 0;
            background-size: 20px 20px;
            background-repeat: repeat;
        }
    </style>
</head>
<body class="font-sans bg-gray-50 min-h-screen text-gray-800 flex flex-col transition-all duration-500" id="app-body">
    
    <canvas id="confetti-canvas"></canvas>

    <!-- Header / Stats Bar (Global) -->
    <div class="w-full max-w-2xl mx-auto px-6 py-4 flex justify-between items-center z-10">
        <div class="flex items-center gap-2 cursor-pointer" onclick="returnToHome()">
            <i class="ph-fill ph-palette text-3xl text-indigo-600"></i>
            <span class="font-bold text-xl tracking-tight">ColorMatch.io</span>
        </div>
        
        <!-- Right Side Header -->
        <div class="flex items-center gap-3">
            <!-- Stats Pill -->
            <div class="flex items-center gap-4 text-sm font-semibold text-gray-600 bg-white px-4 py-2 rounded-full shadow-sm">
                <div class="flex items-center gap-1">
                    <i class="ph-fill ph-fire text-orange-500 text-lg"></i>
                    <span id="streak-display">0</span>
                </div>
                <div class="w-px h-4 bg-gray-300"></div>
                <div>
                    Best: <span id="best-score-display" class="text-indigo-600">--</span>
                </div>
            </div>

            <!-- Auth Button -->
            <button onclick="openAuthModal()" id="auth-btn" class="bg-white p-2 rounded-full shadow-sm hover:bg-gray-50 transition text-gray-600 relative group">
                <i class="ph-fill ph-user text-xl"></i>
                <!-- Tooltip -->
                <span id="auth-tooltip" class="absolute right-0 top-full mt-2 w-max bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">Sign In</span>
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="flex-grow flex items-center justify-center w-full max-w-2xl mx-auto p-6 md:p-8">

        <!-- HOME SCREEN -->
        <div id="home-screen" class="w-full text-center space-y-8 animate-fade-in">
            
            <div class="space-y-4">
                <h1 class="text-4xl md:text-6xl font-black text-gray-900 leading-tight">
                    Can you match<br>
                    <span class="text-indigo-600">today's color?</span>
                </h1>
                <p class="text-lg text-gray-500 max-w-md mx-auto">
                    A new color every day. Memorize it, match it, and keep your streak alive.
                </p>
            </div>

            <!-- Decorative Preview Bubbles -->
            <div class="flex justify-center gap-4 opacity-70">
                <div class="w-12 h-12 rounded-full bg-red-400 animate-pulse-slow"></div>
                <div class="w-12 h-12 rounded-full bg-green-400 animate-pulse-slow" style="animation-delay: 0.5s"></div>
                <div class="w-12 h-12 rounded-full bg-blue-400 animate-pulse-slow" style="animation-delay: 1s"></div>
            </div>

            <div class="flex flex-col gap-3 w-full max-w-sm mx-auto">
                <button onclick="startGame('DAILY')" class="group relative inline-flex items-center justify-center px-8 py-4 font-bold text-white transition-all duration-200 bg-indigo-600 rounded-full hover:bg-indigo-700 hover:shadow-lg hover:-translate-y-1 focus:outline-none ring-offset-2 focus:ring-2 ring-indigo-500 w-full">
                    <span class="text-xl mr-2">Start Daily Challenge</span>
                    <i class="ph-bold ph-arrow-right text-xl group-hover:translate-x-1 transition-transform"></i>
                </button>

                <!-- Impossible Challenge Button -->
                <button onclick="startGame('IMPOSSIBLE')" class="group relative inline-flex items-center justify-center px-8 py-3 font-bold text-white transition-all duration-200 bg-gray-900 rounded-full hover:bg-black hover:shadow-lg hover:-translate-y-1 focus:outline-none ring-offset-2 focus:ring-2 ring-gray-700 w-full overflow-hidden">
                    <span class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1s_infinite]"></span>
                    <span class="text-lg mr-2">Impossible Challenge</span>
                    <i class="ph-bold ph-warning text-xl text-red-500 group-hover:text-red-400"></i>
                </button>
                
                <button onclick="startGame('CHALLENGE_CREATOR')" class="group relative inline-flex items-center justify-center px-8 py-3 font-bold text-indigo-900 transition-all duration-200 bg-yellow-400 rounded-full hover:bg-yellow-300 hover:shadow-lg hover:-translate-y-1 focus:outline-none ring-offset-2 focus:ring-2 ring-yellow-400 w-full">
                    <span class="text-lg mr-2">Challenge a Friend</span>
                    <i class="ph-bold ph-trophy text-xl"></i>
                </button>

                <button onclick="startGame('HARDCORE')" class="group relative inline-flex items-center justify-center px-8 py-3 font-bold text-white transition-all duration-200 bg-red-600 border-2 border-red-600 rounded-full hover:bg-red-700 hover:border-red-700 hover:shadow-lg focus:outline-none ring-offset-2 focus:ring-2 ring-red-500 w-full">
                    <span class="text-lg mr-2">Hardcore Mode</span>
                    <i class="ph-bold ph-skull text-xl group-hover:animate-pulse"></i>
                </button>

                <!-- New Modes Row -->
                <div class="flex gap-3 w-full">
                    <button onclick="startGame('ZEN')" class="flex-1 group relative inline-flex items-center justify-center px-4 py-3 font-bold text-teal-900 transition-all duration-200 bg-teal-300 rounded-full hover:bg-teal-200 hover:shadow-lg hover:-translate-y-1 focus:outline-none ring-offset-2 focus:ring-2 ring-teal-400">
                        <span class="text-lg mr-2">Zen</span>
                        <i class="ph-bold ph-flower-lotus text-xl"></i>
                    </button>
                    <button onclick="startGame('ATTACK')" class="flex-1 group relative inline-flex items-center justify-center px-4 py-3 font-bold text-white transition-all duration-200 bg-orange-500 rounded-full hover:bg-orange-600 hover:shadow-lg hover:-translate-y-1 focus:outline-none ring-offset-2 focus:ring-2 ring-orange-500">
                        <span class="text-lg mr-2">Attack</span>
                        <i class="ph-bold ph-lightning text-xl"></i>
                    </button>
                </div>

                <button onclick="openStore()" class="group relative inline-flex items-center justify-center px-8 py-3 font-bold text-fuchsia-900 transition-all duration-200 bg-fuchsia-300 rounded-full hover:bg-fuchsia-200 hover:shadow-lg hover:-translate-y-1 focus:outline-none ring-offset-2 focus:ring-2 ring-fuchsia-400 w-full">
                    <span class="text-lg mr-2">Color Shop</span>
                    <i class="ph-bold ph-shopping-bag text-xl"></i>
                </button>

                <!-- Challenge Link (Moved to bottom) -->
                <a href="https://colormatch.io" target="_blank" class="group relative inline-flex items-center justify-center px-8 py-3 font-bold text-indigo-900 transition-all duration-200 bg-yellow-400 rounded-full hover:bg-yellow-300 hover:shadow-lg hover:-translate-y-1 focus:outline-none ring-offset-2 focus:ring-2 ring-yellow-400 w-full no-underline">
                    <span class="text-lg mr-2">Challenge a Friend</span>
                    <i class="ph-bold ph-trophy text-xl"></i>
                </a>
            </div>

            <div class="text-sm text-gray-400 font-medium">
                Resets at Midnight Local Time
            </div>
        </div>

        <!-- GAME CONTAINER (Initially Hidden) -->
        <div id="game-container" class="w-full flex flex-col items-center hidden">

            <!-- CHALLENGE BANNER -->
            <div id="challenge-banner" class="hidden w-full bg-yellow-100 border border-yellow-200 rounded-xl p-3 mb-6 flex items-center justify-center gap-2 text-yellow-800 animate-pulse-slow">
                <i class="ph-fill ph-sword text-xl"></i>
                <span class="font-bold">You have been challenged! Beat score: <span id="opponent-score-display">--</span></span>
            </div>

            <div class="text-center mb-6 w-full">
                <div class="flex items-center justify-center gap-2 mb-1">
                    <h2 class="text-3xl font-black text-gray-900" id="game-title">Match It!</h2>
                    <span id="hardcore-badge" class="hidden bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">HARDCORE</span>
                    <span id="impossible-badge" class="hidden bg-black text-white border border-gray-700 text-xs font-bold px-2 py-1 rounded-full animate-pulse">IMPOSSIBLE</span>
                    <span id="zen-badge" class="hidden bg-teal-500 text-white text-xs font-bold px-2 py-1 rounded-full">ZEN</span>
                    <span id="attack-badge" class="hidden bg-orange-500 text-white text-xs font-bold px-2 py-1 rounded-full">TIME ATTACK</span>
                </div>
                
                <div class="flex justify-between items-center w-full px-2">
                    <p id="game-instructions" class="text-gray-500 text-sm text-left">Memorize, then mix...</p>
                    <div class="text-right">
                        <div id="timer-display" class="text-xl font-mono font-bold text-gray-400 transition-colors duration-300">0.0s</div>
                        <!-- New Session Score Display -->
                        <div id="session-score-container" class="hidden text-xs font-bold text-indigo-600 uppercase tracking-wider mt-1">
                            Score: <span id="session-score-value">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unified Color Display Section -->
            <div class="w-full mb-8 relative">
                <!-- Single Large Display Box -->
                <div id="main-color-display" class="w-full h-64 md:h-80 rounded-3xl shadow-xl border border-gray-200 overflow-hidden relative transition-colors duration-500 ease-in-out flex items-center justify-center">
                    
                    <!-- Overlay for Countdown / Status -->
                    <div id="target-overlay" class="text-center z-10 pointer-events-none">
                        <!-- Content injected via JS -->
                    </div>

                    <!-- Label tag (Optional) -->
                    <div id="display-label" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white/20 backdrop-blur-md text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest transition-opacity duration-300">
                        Target Color
                    </div>
                </div>
            </div>

            <!-- Manual Inputs (Impossible Mode) -->
            <div id="inputs-container" class="hidden w-full space-y-6 bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-gray-100 mb-8 transition-opacity duration-300">
                <div class="flex flex-col space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="w-12 font-bold text-red-500 text-xl text-right">R</label>
                        <input type="number" id="input-r" min="0" max="255" placeholder="0-255" class="flex-1 p-4 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-red-500 focus:ring-2 focus:ring-red-200 outline-none font-mono text-xl text-center" oninput="handleManualInput()">
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="w-12 font-bold text-green-500 text-xl text-right">G</label>
                        <input type="number" id="input-g" min="0" max="255" placeholder="0-255" class="flex-1 p-4 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none font-mono text-xl text-center" oninput="handleManualInput()">
                    </div>
                    <div class="flex items-center space-x-4">
                        <label class="w-12 font-bold text-blue-500 text-xl text-right">B</label>
                        <input type="number" id="input-b" min="0" max="255" placeholder="0-255" class="flex-1 p-4 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none font-mono text-xl text-center" oninput="handleManualInput()">
                    </div>
                </div>
            </div>

            <!-- RGB Sliders -->
            <div id="sliders-container" class="w-full space-y-8 bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-gray-100 mb-8 transition-opacity duration-300">
                <!-- Red Slider -->
                <div class="relative group">
                    <div class="flex justify-between mb-2 text-sm font-bold text-gray-500">
                        <span class="text-red-500">RED</span>
                        <span id="value-r" class="font-mono bg-gray-100 px-2 rounded">0</span>
                    </div>
                    <input type="range" min="0" max="255" value="0" id="slider-r" class="text-red-500" oninput="handleInput('r')" disabled>
                </div>
                <!-- Green Slider -->
                <div class="relative group">
                    <div class="flex justify-between mb-2 text-sm font-bold text-gray-500">
                        <span class="text-green-500">GREEN</span>
                        <span id="value-g" class="font-mono bg-gray-100 px-2 rounded">0</span>
                    </div>
                    <input type="range" min="0" max="255" value="0" id="slider-g" class="text-green-500" oninput="handleInput('g')" disabled>
                </div>
                <!-- Blue Slider -->
                <div class="relative group">
                    <div class="flex justify-between mb-2 text-sm font-bold text-gray-500">
                        <span class="text-blue-500">BLUE</span>
                        <span id="value-b" class="font-mono bg-gray-100 px-2 rounded">0</span>
                    </div>
                    <input type="range" min="0" max="255" value="0" id="slider-b" class="text-blue-500" oninput="handleInput('b')" disabled>
                </div>
            </div>

            <!-- Submission Button (Using handleMainAction now) -->
            <button id="submit-button" onclick="handleMainAction()" disabled class="w-full md:w-auto md:min-w-[300px] py-4 bg-gray-400 text-white font-bold text-lg rounded-2xl shadow-xl transition-all duration-200 flex items-center justify-center gap-2 cursor-not-allowed">
                <span>Reveal Result</span>
                <i class="ph-bold ph-magic-wand"></i>
            </button>

            <!-- Try Again Button (Hardcore/Impossible) - Inside Modal -->
            <button id="modal-try-again-btn" onclick="hideResultModal()" class="hidden w-full py-3 bg-gray-800 text-white font-bold rounded-xl hover:bg-gray-900 transition flex items-center justify-center gap-2 text-sm shadow-lg">
                <i class="ph-bold ph-arrow-counter-clockwise"></i>
                Try Again
            </button>

            <!-- Challenge Mode Actions (For Creator) -->
            <div id="challenge-creator-actions" class="hidden">
                <button onclick="copyChallengeLink()" class="w-full py-3 bg-yellow-400 text-indigo-900 font-bold rounded-xl shadow-lg shadow-yellow-200 hover:bg-yellow-300 transition flex items-center justify-center gap-2 active:scale-95">
                    <i class="ph-bold ph-link"></i>
                    Copy Challenge Link
                </button>
                <p class="text-xs text-gray-400 text-center mt-2">Send this link to a friend to see if they can beat your score!</p>
            </div>

            <!-- Next Level Button (Zen/Attack) -->
            <button id="next-level-btn" onclick="nextRound()" class="hidden w-full py-3 bg-teal-500 text-white font-bold rounded-xl shadow-lg shadow-teal-200 hover:bg-teal-600 transition flex items-center justify-center gap-2 active:scale-95">
                <i class="ph-bold ph-arrow-right"></i>
                Next Color
            </button>
            
            <!-- Return Home Button (Results Modal) -->
            <button onclick="returnToHome()" class="w-full mt-3 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200 transition flex items-center justify-center gap-2 text-sm">
                <i class="ph-bold ph-house"></i>
                Return to Home
            </button>
            
            <div id="daily-countdown-container" class="pt-4 border-t border-gray-100">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Next Color In</p>
                <div id="countdown" class="text-xl font-mono font-bold text-gray-800">00:00:00</div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="/* prevent close */"></div>
        
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl relative transform transition-all scale-95 opacity-0 animate-bounce-short" id="result-content">
            
            <div class="absolute -top-12 left-1/2 transform -translate-x-1/2 bg-white p-3 rounded-full shadow-lg border-4 border-indigo-50">
                <span id="result-emoji" class="text-5xl">ðŸ¤”</span>
            </div>

            <div class="mt-8">
                <h2 class="text-2xl font-black text-gray-800 mb-1" id="result-title">Not Bad!</h2>
                <p class="text-sm text-gray-500 mb-6" id="result-message">You were close.</p>
            </div>

            <!-- Score Card -->
            <div class="bg-gray-50 rounded-2xl p-6 mb-6 border border-gray-100">
                <p class="text-xs uppercase tracking-widest font-bold text-gray-400 mb-2" id="score-label">Total Score</p>
                <div class="flex flex-col items-center justify-center mb-2">
                    <span id="score-output" class="text-5xl font-black text-indigo-600">0</span>
                    <span id="accuracy-subtext" class="text-sm font-bold text-gray-500 mt-1">Accuracy: 0%</span>
                </div>
                <div class="text-xs text-gray-400" id="score-detail-text">(Speed + Accuracy)</div>
            </div>

            <!-- Comparison Visuals -->
            <div id="comparison-visuals" class="grid grid-cols-2 gap-4 mb-4">
                <div class="flex flex-col items-center">
                     <div id="modal-target-swatch" class="w-16 h-16 rounded-full shadow-md border-2 border-white ring-2 ring-gray-100 mb-2"></div>
                     <span class="text-xs font-bold text-gray-500 uppercase">Target</span>
                     <span id="target-rgb-result" class="text-xs font-mono text-gray-400"></span>
                </div>
                <div class="flex flex-col items-center">
                    <div id="modal-user-swatch" class="w-16 h-16 rounded-full shadow-md border-2 border-white ring-2 ring-gray-100 mb-2"></div>
                    <span class="text-xs font-bold text-gray-500 uppercase">Yours</span>
                    <span id="user-rgb-result" class="text-xs font-mono text-gray-400"></span>
               </div>
            </div>
            
            <div id="time-result-container" class="bg-gray-100 p-2 rounded text-xs font-mono text-gray-500 mb-6">
                Time: <span id="time-result" class="font-bold text-gray-900">--</span>
            </div>

            <!-- Action Buttons -->
            <div class="space-y-3" id="action-buttons-container">
                <!-- Standard Share/Download -->
                <div id="standard-actions" class="flex gap-2">
                    <button onclick="shareResult()" id="share-btn" class="flex-1 py-3 bg-indigo-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-600 transition flex items-center justify-center gap-2 active:scale-95 text-sm">
                        <i class="ph-bold ph-copy"></i>
                        Copy Text
                    </button>
                    <button onclick="downloadResultImage()" id="save-img-btn" class="flex-1 py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg shadow-green-200 hover:bg-green-600 transition flex items-center justify-center gap-2 active:scale-95 text-sm">
                        <i class="ph-bold ph-download-simple"></i>
                        Save Image
                    </button>
                </div>

                <!-- Try Again Button (Hardcore/Impossible) - Inside Modal -->
                <button id="modal-try-again-btn" onclick="hideResultModal()" class="hidden w-full py-3 bg-gray-800 text-white font-bold rounded-xl hover:bg-gray-900 transition flex items-center justify-center gap-2 text-sm shadow-lg">
                    <i class="ph-bold ph-arrow-counter-clockwise"></i>
                    Try Again
                </button>

                <!-- Challenge Mode Actions (For Creator) -->
                <div id="challenge-creator-actions" class="hidden">
                    <button onclick="copyChallengeLink()" class="w-full py-3 bg-yellow-400 text-indigo-900 font-bold rounded-xl shadow-lg shadow-yellow-200 hover:bg-yellow-300 transition flex items-center justify-center gap-2 active:scale-95">
                        <i class="ph-bold ph-link"></i>
                        Copy Challenge Link
                    </button>
                    <p class="text-xs text-gray-400 text-center mt-2">Send this link to a friend to see if they can beat your score!</p>
                </div>

                <!-- Next Level Button (Zen/Attack) -->
                <button id="next-level-btn" onclick="nextRound()" class="hidden w-full py-3 bg-teal-500 text-white font-bold rounded-xl shadow-lg shadow-teal-200 hover:bg-teal-600 transition flex items-center justify-center gap-2 active:scale-95">
                    <i class="ph-bold ph-arrow-right"></i>
                    Next Color
                </button>
                
                <!-- Return Home Button (Results Modal) -->
                <button onclick="returnToHome()" class="w-full mt-3 py-3 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200 transition flex items-center justify-center gap-2 text-sm">
                    <i class="ph-bold ph-house"></i>
                    Return to Home
                </button>
                
                <div id="daily-countdown-container" class="pt-4 border-t border-gray-100">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Next Color In</p>
                    <div id="countdown" class="text-xl font-mono font-bold text-gray-800">00:00:00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Store Modal -->
    <div id="store-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeStore()"></div>
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl relative transform transition-all scale-95 opacity-0" id="store-content">
            <!-- ... Store Content ... -->
             <div class="text-center">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-fuchsia-100 rounded-full text-fuchsia-600 mb-4">
                    <i class="ph-fill ph-shopping-bag text-3xl"></i>
                </div>
                <h2 class="text-3xl font-black text-gray-900 mb-1">Color Shop</h2>
                <p class="text-gray-500 mb-6 text-sm">Customize your experience</p>
                
                <div class="space-y-6 mb-6 text-left">
                    
                    <!-- Background Patterns Section -->
                    <div>
                        <h3 class="font-bold text-gray-800 mb-3 text-sm uppercase tracking-wider">Background Patterns</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="setPattern('none')" class="h-20 rounded-xl border-2 border-gray-200 bg-gray-50 hover:border-indigo-500 hover:shadow-md focus:ring-2 ring-indigo-200 transition flex items-center justify-center text-gray-400 font-bold group active:scale-95">
                                <span class="group-hover:text-gray-600">Default</span>
                            </button>
                            <button onclick="setPattern('pattern-dots')" class="h-20 rounded-xl border-2 border-rose-200 bg-rose-50 pattern-dots hover:border-rose-500 hover:shadow-md focus:ring-2 ring-rose-200 transition active:scale-95 relative overflow-hidden">
                                <span class="bg-white/90 px-2 py-1 rounded text-xs font-bold text-rose-600 backdrop-blur-sm shadow-sm">Polka</span>
                            </button>
                            <button onclick="setPattern('pattern-grid')" class="h-20 rounded-xl border-2 border-blue-200 bg-blue-50 pattern-grid hover:border-blue-500 hover:shadow-md focus:ring-2 ring-blue-200 transition active:scale-95 relative overflow-hidden">
                                <span class="bg-white/90 px-2 py-1 rounded text-xs font-bold text-blue-600 backdrop-blur-sm shadow-sm">Graph</span>
                            </button>
                            <button onclick="setPattern('pattern-diagonal')" class="h-20 rounded-xl border-2 border-orange-200 bg-orange-50 pattern-diagonal hover:border-orange-500 hover:shadow-md focus:ring-2 ring-orange-200 transition active:scale-95 relative overflow-hidden">
                                <span class="bg-white/90 px-2 py-1 rounded text-xs font-bold text-orange-600 backdrop-blur-sm shadow-sm">Stripes</span>
                            </button>
                            <button onclick="setPattern('pattern-zigzag')" class="h-20 rounded-xl border-2 border-teal-200 bg-teal-50 pattern-zigzag hover:border-teal-500 hover:shadow-md focus:ring-2 ring-teal-200 transition active:scale-95 relative overflow-hidden col-span-2">
                                <span class="bg-white/90 px-2 py-1 rounded text-xs font-bold text-teal-600 backdrop-blur-sm shadow-sm">Zig Zag</span>
                            </button>
                        </div>
                    </div>

                    <!-- Coming Soon Section -->
                    <div class="opacity-50 pointer-events-none grayscale">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-900 flex items-center justify-center text-white">
                                    <i class="ph-fill ph-moon"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800 text-sm">Dark Mode</p>
                                    <p class="text-xs text-gray-400 font-medium">Coming Soon</p>
                                </div>
                            </div>
                            <i class="ph-bold ph-lock text-gray-400 text-xl"></i>
                        </div>
                    </div>
                </div>

                <button onclick="closeStore()" class="w-full py-3 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition active:scale-95">
                    Close Shop
                </button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeAuthModal()"></div>
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl relative transform transition-all scale-95 opacity-0" id="auth-content">
            <div class="text-center">
                <h2 class="text-3xl font-black text-gray-900 mb-2" id="auth-title">Sign In</h2>
                <p class="text-gray-500 mb-6 text-sm" id="auth-subtitle">Save your stats and streaks!</p>
                
                <div class="space-y-4 text-left">
                    <!-- Username Field (Signup Only) -->
                    <div id="username-field" class="hidden">
                        <label class="block text-sm font-bold text-gray-700 mb-1">Username</label>
                        <input type="text" id="auth-username" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>

                    <!-- Email Field -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Email</label>
                        <input type="email" id="auth-email" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>

                    <!-- Password Field -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Password</label>
                        <input type="password" id="auth-password" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>

                    <!-- Error Message -->
                    <div id="auth-error" class="text-red-500 text-sm text-center hidden"></div>

                    <button onclick="handleAuthSubmit()" id="auth-submit-btn" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition active:scale-95 mt-2">
                        Sign In
                    </button>
                </div>

                <div class="mt-6 text-sm text-gray-500">
                    <span id="auth-toggle-text">Don't have an account?</span>
                    <button onclick="toggleAuthMode()" class="text-indigo-600 font-bold hover:underline ml-1" id="auth-toggle-btn">Sign Up</button>
                </div>
                
                <!-- Logout Button (Hidden by default) -->
                <button onclick="handleLogout()" id="auth-logout-btn" class="hidden w-full py-3 bg-red-100 text-red-600 font-bold rounded-xl hover:bg-red-200 transition active:scale-95 mt-4">
                    Log Out
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 pointer-events-none transition-opacity duration-300 z-[60] flex items-center gap-2">
        <i class="ph-fill ph-check-circle text-green-400"></i>
        <span id="toast-message">Copied to clipboard!</span>
    </div>

    <script type="module">
        // --- Firebase/Auth Setup ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // User provided configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCd6g0b7haTrz0z4xtAru_wf4SLWpNEwKM",
            authDomain: "colormatch-41ad8.firebaseapp.com",
            projectId: "colormatch-41ad8",
            storageBucket: "colormatch-41ad8.firebasestorage.app",
            messagingSenderId: "671535233850",
            appId: "1:671535233850:web:fd65344518c13d5d152e03",
            measurementId: "G-J3MD0ZM9CM"
        };
        
        let auth;
        let db;
        let analytics;
        let currentUser = null;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            analytics = getAnalytics(app);
            
            // Listen for auth changes
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                updateAuthUI(user);
                
                if (user && !user.isAnonymous) {
                    syncStatsFromCloud(user);
                }
            });
            
            signInAnonymously(auth).catch(err => console.log("Anon auth skipped/failed (might be signed in)", err)); 
            
        } catch (e) {
            console.error("Firebase Init Error", e);
        }

        // --- Database Logic ---
        async function syncStatsFromCloud(user) {
            try {
                // Path: users/{uid}
                const docRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const cloudStats = docSnap.data();
                    const localStats = loadStats();

                    // Merge Logic: Keep best
                    const mergedStats = {
                        streak: Math.max(cloudStats.streak || 0, localStats.streak),
                        bestScore: Math.max(cloudStats.bestScore || 0, localStats.bestScore),
                        lastPlayed: (cloudStats.lastPlayed > localStats.lastPlayed) ? cloudStats.lastPlayed : localStats.lastPlayed
                    };

                    localStorage.setItem('dcm_stats', JSON.stringify(mergedStats));
                    updateUIStats();
                }
            } catch (error) {
                console.error("Error syncing stats:", error);
            }
        }
        
        // --- Auth UI Logic ---
        let isLoginMode = true;

        window.openAuthModal = function() {
            if (currentUser && !currentUser.isAnonymous) {
                // Profile View
                document.getElementById('auth-title').textContent = "Profile";
                document.getElementById('auth-subtitle').textContent = `Signed in as ${currentUser.displayName || currentUser.email}`;
                document.getElementById('username-field').classList.add('hidden');
                document.getElementById('auth-email').parentElement.classList.add('hidden'); 
                document.getElementById('auth-password').parentElement.classList.add('hidden');
                document.getElementById('auth-submit-btn').classList.add('hidden');
                document.getElementById('auth-toggle-text').parentElement.classList.add('hidden');
                document.getElementById('auth-logout-btn').classList.remove('hidden');
            } else {
                // Login View
                isLoginMode = true;
                updateAuthModalState();
                document.getElementById('auth-email').parentElement.classList.remove('hidden');
                document.getElementById('auth-password').parentElement.classList.remove('hidden');
                document.getElementById('auth-submit-btn').classList.remove('hidden');
                document.getElementById('auth-toggle-text').parentElement.classList.remove('hidden');
                document.getElementById('auth-logout-btn').classList.add('hidden');
            }

            const modal = document.getElementById('auth-modal');
            const content = document.getElementById('auth-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        window.closeAuthModal = function() {
            const modal = document.getElementById('auth-modal');
            const content = document.getElementById('auth-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        window.toggleAuthMode = function() {
            isLoginMode = !isLoginMode;
            updateAuthModalState();
        }

        function updateAuthModalState() {
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');
            const submitBtn = document.getElementById('auth-submit-btn');
            const toggleText = document.getElementById('auth-toggle-text');
            const toggleBtn = document.getElementById('auth-toggle-btn');
            const usernameField = document.getElementById('username-field');
            const errorMsg = document.getElementById('auth-error');

            errorMsg.classList.add('hidden');

            if (isLoginMode) {
                title.textContent = "Sign In";
                subtitle.textContent = "Welcome back!";
                submitBtn.textContent = "Sign In";
                toggleText.textContent = "Don't have an account?";
                toggleBtn.textContent = "Sign Up";
                usernameField.classList.add('hidden');
            } else {
                title.textContent = "Create Account";
                subtitle.textContent = "Join the leaderboard!";
                submitBtn.textContent = "Sign Up";
                toggleText.textContent = "Already have an account?";
                toggleBtn.textContent = "Sign In";
                usernameField.classList.remove('hidden');
            }
        }

        window.handleAuthSubmit = async function() {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const username = document.getElementById('auth-username').value;
            const errorMsg = document.getElementById('auth-error');

            errorMsg.classList.add('hidden');

            if (!email || !password) {
                showAuthError("Please fill in all fields");
                return;
            }

            if (!isLoginMode && !username) {
                showAuthError("Username is required");
                return;
            }

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCred = await createUserWithEmailAndPassword(auth, email, password);
                    await updateProfile(userCred.user, { displayName: username });
                }
                closeAuthModal();
                showToast(`Welcome, ${isLoginMode ? "back!" : username}`);
            } catch (error) {
                console.error("Auth Error:", error);
                let msg = "Authentication failed.";
                if (error.code === 'auth/email-already-in-use') msg = "Email already in use.";
                if (error.code === 'auth/weak-password') msg = "Password should be at least 6 characters.";
                if (error.code === 'auth/invalid-email') msg = "Invalid email address.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') msg = "Invalid email or password.";
                showAuthError(msg);
            }
        }

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                closeAuthModal();
                showToast("Logged out successfully");
                signInAnonymously(auth);
            } catch (error) {
                console.error("Logout Error:", error);
            }
        }

        function showAuthError(msg) {
            const el = document.getElementById('auth-error');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        function updateAuthUI(user) {
            const tooltip = document.getElementById('auth-tooltip');
            const icon = document.querySelector('#auth-btn i');
            
            if (user && !user.isAnonymous) {
                icon.classList.remove('ph-user');
                icon.classList.add('ph-user-circle', 'text-indigo-600');
                tooltip.textContent = user.displayName || "User";
            } else {
                icon.classList.add('ph-user');
                icon.classList.remove('ph-user-circle', 'text-indigo-600');
                tooltip.textContent = "Sign In";
            }
        }
        // --- END Firebase/Auth Setup ---

        // --- Game Logic ---
        let TARGET_COLOR = { r: 0, g: 0, b: 0 };
        let OPPONENT_SCORE = null;
        let HAS_SUBMITTED = false;
        let IS_CREATING = false; 
        let CURRENT_PATTERN = localStorage.getItem('dcm_pattern') || 'none';
        
        // Game Modes: 'DAILY', 'HARDCORE', 'CHALLENGE_CREATOR', 'CHALLENGE_PLAYER', 'ZEN', 'ATTACK', 'IMPOSSIBLE'
        let GAME_MODE = 'DAILY'; 
        
        let CURRENT_ACCURACY = 0;
        let GAME_DATE_ID = ""; 
        
        let startTime = null;
        let timerInterval = null;
        let fadeInterval = null; 
        let timeTaken = 0;
        let finalScore = 0;
        
        // Attack/Session Score Vars
        let attackTimeLeft = 60;
        let sessionScore = 0; // Combined score for Attack & Zen
        let attackTimerInterval = null;
        
        // Impossible Mode attempts
        let impossibleGuesses = 0;

        // --- Stats & Persistence ---
        function loadStats() {
            const stored = localStorage.getItem('dcm_stats');
            const defaultStats = { streak: 0, lastPlayed: null, bestScore: 0 };
            return stored ? JSON.parse(stored) : defaultStats;
        }

        function saveStats(stats) {
            // 1. Save Local
            localStorage.setItem('dcm_stats', JSON.stringify(stats));
            
            // 2. Save Cloud
            if (currentUser && !currentUser.isAnonymous && db) {
                const docRef = doc(db, 'users', currentUser.uid);
                setDoc(docRef, stats, { merge: true }).catch(e => console.log("Cloud save failed", e));
            }
        }

        function updateUIStats() {
            const stats = loadStats();
            document.getElementById('streak-display').textContent = stats.streak;
            document.getElementById('best-score-display').textContent = stats.bestScore !== null ? stats.bestScore : '0';
        }

        // --- Pattern Logic ---
        window.setPattern = function(patternName) {
            const body = document.getElementById('app-body');
            body.classList.remove('pattern-dots', 'pattern-grid', 'pattern-diagonal', 'pattern-zigzag');
            if (patternName !== 'none') body.classList.add(patternName);
            CURRENT_PATTERN = patternName;
            localStorage.setItem('dcm_pattern', patternName);
            if (navigator.vibrate) navigator.vibrate(5);
        }

        function initPattern() {
            if (CURRENT_PATTERN && CURRENT_PATTERN !== 'none') setPattern(CURRENT_PATTERN);
        }

        // --- Color Generators ---
        function getDailyColor(date) {
            GAME_DATE_ID = date.getFullYear() * 10000 + (date.getMonth() + 1) * 100 + date.getDate();
            const seed = GAME_DATE_ID;
            const M = 0x80000000; 
            const A = 1103515245;
            const C = 12345;
            let state = seed;
            function next() { state = (A * state + C) % M; return state / M; }
            next(); next();
            const r = Math.floor(next() * 256);
            const g = Math.floor(next() * 256);
            const b = Math.floor(next() * 256);
            return { r, g, b };
        }

        function getRandomColor() {
            return {
                r: Math.floor(Math.random() * 256),
                g: Math.floor(Math.random() * 256),
                b: Math.floor(Math.random() * 256)
            };
        }

        // --- Initialization ---
        function initGame() {
            initPattern();
            updateUIStats();
            startCountdown(); // For daily timer

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('mode') && urlParams.get('mode') === 'challenge') {
                handleChallengeReceiver(urlParams);
            }
        }

        function handleChallengeReceiver(params) {
            const r = parseInt(params.get('r'));
            const g = parseInt(params.get('g'));
            const b = parseInt(params.get('b'));
            OPPONENT_SCORE = parseInt(params.get('s') || '0');

            if (!isNaN(r) && !isNaN(g) && !isNaN(b)) {
                TARGET_COLOR = { r, g, b };
                document.getElementById('home-screen').classList.add('hidden');
                document.getElementById('game-container').classList.remove('hidden');
                GAME_MODE = 'CHALLENGE_PLAYER';
                const banner = document.getElementById('challenge-banner');
                banner.classList.remove('hidden');
                banner.classList.add('flex');
                document.getElementById('opponent-score-display').textContent = OPPONENT_SCORE.toLocaleString();
                setupGameUI();
                startMemoryFade();
            }
        }

        // --- Transition Logic ---
        window.startGame = function(mode) {
            GAME_MODE = mode;

            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            document.getElementById('game-container').classList.add('animate-fade-in');
            document.getElementById('challenge-banner').classList.add('hidden');

            // Reset Badges & Score display
            document.getElementById('hardcore-badge').classList.add('hidden');
            document.getElementById('zen-badge').classList.add('hidden');
            document.getElementById('attack-badge').classList.add('hidden');
            document.getElementById('impossible-badge').classList.add('hidden');
            document.getElementById('session-score-container').classList.add('hidden');

            // Reset Container Visibility
            document.getElementById('sliders-container').classList.remove('hidden');
            document.getElementById('inputs-container').classList.add('hidden');

            // Setup based on Mode
            if (GAME_MODE === 'DAILY' || GAME_MODE === 'HARDCORE' || GAME_MODE === 'IMPOSSIBLE') {
                IS_CREATING = false;
                
                if (GAME_MODE === 'IMPOSSIBLE') {
                    TARGET_COLOR = getRandomColor();
                    impossibleGuesses = 0;
                    document.getElementById('impossible-badge').classList.remove('hidden');
                    // Hide sliders, show inputs
                    document.getElementById('sliders-container').classList.add('hidden');
                    document.getElementById('inputs-container').classList.remove('hidden');
                    // Reset inputs
                    document.getElementById('input-r').value = '';
                    document.getElementById('input-g').value = '';
                    document.getElementById('input-b').value = '';
                } else {
                    const today = new Date();
                    TARGET_COLOR = getDailyColor(today);
                    if(GAME_MODE === 'HARDCORE') document.getElementById('hardcore-badge').classList.remove('hidden');
                }
                
                setupGameUI();
                startMemoryFade();
            } 
            else if (GAME_MODE === 'CHALLENGE_CREATOR') {
                startCreationPhase();
            } 
            else if (GAME_MODE === 'ZEN') {
                IS_CREATING = false;
                TARGET_COLOR = getRandomColor();
                sessionScore = 0; // Reset zen score
                document.getElementById('zen-badge').classList.remove('hidden');
                document.getElementById('session-score-container').classList.remove('hidden');
                document.getElementById('session-score-value').textContent = "0";
                setupGameUI();
                startMemoryFade(); 
            } 
            else if (GAME_MODE === 'ATTACK') {
                IS_CREATING = false;
                TARGET_COLOR = getRandomColor();
                sessionScore = 0; 
                attackTimeLeft = 60;
                document.getElementById('attack-badge').classList.remove('hidden');
                document.getElementById('session-score-container').classList.remove('hidden');
                document.getElementById('session-score-value').textContent = "0";
                
                if (attackTimerInterval) clearInterval(attackTimerInterval);
                attackTimerInterval = setInterval(() => {
                    attackTimeLeft--;
                    updateTimerDisplay();
                    if (attackTimeLeft <= 0) endAttackGame();
                }, 1000);

                setupGameUI();
                startMemoryFade();
            }
        }
        
        function startCreationPhase() {
            IS_CREATING = true;
            HAS_SUBMITTED = false;
            document.getElementById('game-title').textContent = "Design Color";
            document.getElementById('game-instructions').textContent = "Mix a tough color, then play!";
            setSlidersLocked(false);
            document.getElementById('slider-r').value = 127;
            document.getElementById('slider-g').value = 127;
            document.getElementById('slider-b').value = 127;
            
            const submitBtn = document.getElementById('submit-button');
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'hover:shadow-2xl');
            submitBtn.querySelector('span').textContent = "Challenge a Friend!";
            submitBtn.querySelector('i').className = "ph-bold ph-check-circle";
            updateColor();
        }
        
        function confirmChallengeColor() {
            const r = parseInt(document.getElementById('slider-r').value);
            const g = parseInt(document.getElementById('slider-g').value);
            const b = parseInt(document.getElementById('slider-b').value);
            TARGET_COLOR = { r, g, b };
            IS_CREATING = false;
            document.getElementById('game-title').textContent = "Match It!";
            document.getElementById('game-instructions').textContent = "Memorize, then mix...";
            setupGameUI();
            const submitBtn = document.getElementById('submit-button');
            submitBtn.querySelector('span').textContent = "Reveal Result";
            submitBtn.querySelector('i').className = "ph-bold ph-magic-wand";
            startMemoryFade();
        }

        window.handleMainAction = function() {
            if (IS_CREATING) {
                confirmChallengeColor();
            } else {
                calculateScore();
            }
        }

        function setupGameUI() {
            HAS_SUBMITTED = false;
            
            const submitBtn = document.getElementById('submit-button');
            submitBtn.disabled = true;
            
            // Reset Button State
            if (GAME_MODE === 'ZEN') {
                submitBtn.querySelector('span').textContent = "See Results";
                submitBtn.querySelector('i').className = "ph-bold ph-eye";
            } else {
                submitBtn.querySelector('span').textContent = "Reveal Result";
                submitBtn.querySelector('i').className = "ph-bold ph-magic-wand";
            }

            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('slider-r').value = 127;
            document.getElementById('slider-g').value = 127;
            document.getElementById('slider-b').value = 127;
            
            updateTimerDisplay();
            
            const mainDisplay = document.getElementById('main-color-display');
            mainDisplay.style.backgroundColor = `rgb(${TARGET_COLOR.r}, ${TARGET_COLOR.g}, ${TARGET_COLOR.b})`;
            
            updateColor(); 
        }

        function updateTimerDisplay() {
            const display = document.getElementById('timer-display');
            if (GAME_MODE === 'ZEN') {
                display.textContent = "âˆž";
                display.className = "text-xl font-mono font-bold text-teal-500";
            } else if (GAME_MODE === 'ATTACK') {
                display.textContent = attackTimeLeft + "s";
                display.className = `text-xl font-mono font-bold ${attackTimeLeft < 10 ? 'text-red-600 animate-pulse' : 'text-orange-500'}`;
            } else {
                // Daily / Hardcore / Challenge
                display.textContent = startTime ? timeTaken + "s" : "0.0s";
                display.className = "text-xl font-mono font-bold text-gray-400 transition-colors duration-300";
                if(startTime) display.classList.add('text-indigo-900');
            }
        }

        window.returnToHome = function() {
            if (fadeInterval) clearInterval(fadeInterval);
            if (timerInterval) clearInterval(timerInterval);
            if (attackTimerInterval) clearInterval(attackTimerInterval);
            
            if (window.location.search) {
                window.history.pushState({}, document.title, window.location.pathname);
            }
            
            startTime = null;
            timeTaken = 0;
            IS_CREATING = false;

            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
            
            document.getElementById('hardcore-badge').classList.add('hidden');
            document.getElementById('impossible-badge').classList.add('hidden');
            document.getElementById('zen-badge').classList.add('hidden');
            document.getElementById('attack-badge').classList.add('hidden');
            document.getElementById('game-title').textContent = "Match It!";
            
            document.getElementById('main-color-display').style.background = '';
            document.getElementById('main-color-display').classList.add('transition-colors', 'duration-500');
        }

        // --- Store Logic ---
        window.openStore = function() {
            const modal = document.getElementById('store-modal');
            const content = document.getElementById('store-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        window.closeStore = function() {
            const modal = document.getElementById('store-modal');
            const content = document.getElementById('store-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- Memory Phase Logic ---
        function startMemoryFade() {
            const display = document.getElementById('main-color-display');
            const overlay = document.getElementById('target-overlay');
            const label = document.getElementById('display-label');
            
            display.style.backgroundColor = `rgb(${TARGET_COLOR.r}, ${TARGET_COLOR.g}, ${TARGET_COLOR.b})`;
            overlay.innerHTML = '<span class="text-white/90 font-black text-2xl drop-shadow-md tracking-wider">MEMORIZE!</span>';
            overlay.classList.remove('hidden');
            
            label.textContent = "Target Color";
            label.classList.remove('opacity-0');
            label.classList.remove('bg-red-500/80');
            label.classList.remove('hidden');
            
            if (GAME_MODE === 'ZEN') {
                overlay.innerHTML = `
                    <div class="absolute inset-0 flex w-full h-full pointer-events-none">
                        <div class="w-1/2 h-full flex items-end justify-center pb-4">
                            <span class="bg-white/20 backdrop-blur-md text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest shadow-sm">Target</span>
                        </div>
                        <div class="w-1/2 h-full flex items-end justify-center pb-4">
                            <span class="bg-white/20 backdrop-blur-md text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest shadow-sm">Your Mix</span>
                        </div>
                    </div>
                `;
                overlay.classList.remove('hidden');
                label.classList.add('hidden');
                display.classList.remove('transition-colors', 'duration-500');
                setSlidersLocked(false);
                const submitBtn = document.getElementById('submit-button');
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'hover:shadow-2xl', 'transform', 'hover:-translate-y-1', 'active:scale-95');
                updateColor();
                return;
            }

            setSlidersLocked(true);

            let timeLeft = 3; 
            if (GAME_MODE === 'DAILY' || GAME_MODE === 'HARDCORE' || GAME_MODE === 'CHALLENGE_PLAYER') timeLeft = 5;
            if (GAME_MODE === 'IMPOSSIBLE') timeLeft = 5;

            if (fadeInterval) clearInterval(fadeInterval);
            
            fadeInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft > 0) {
                     overlay.innerHTML = `<span class="text-white/90 font-black text-6xl drop-shadow-md animate-pulse">${timeLeft}</span>`;
                } else {
                    clearInterval(fadeInterval);
                    overlay.innerHTML = ''; 
                    
                    if (GAME_MODE === 'HARDCORE' || GAME_MODE === 'IMPOSSIBLE') {
                        label.textContent = "Blind Mix";
                        label.classList.add('bg-red-500/80');
                    } else {
                        label.textContent = "Your Mix";
                    }
                    
                    setSlidersLocked(false);
                    
                    const submitBtn = document.getElementById('submit-button');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'hover:shadow-2xl', 'transform', 'hover:-translate-y-1', 'active:scale-95');

                    updateColor(); 
                }
            }, 1000);
        }

        function setSlidersLocked(locked) {
            // Sliders
            const ids = ['slider-r', 'slider-g', 'slider-b'];
            ids.forEach(id => {
                document.getElementById(id).disabled = locked;
            });
            const container = document.getElementById('sliders-container');
            if (locked) {
                container.classList.add('opacity-50', 'grayscale');
            } else {
                container.classList.remove('opacity-50', 'grayscale');
            }

            // Inputs
            const inputIds = ['input-r', 'input-g', 'input-b'];
            inputIds.forEach(id => {
                document.getElementById(id).disabled = locked;
            });
            const inputContainer = document.getElementById('inputs-container');
            if (locked) {
                inputContainer.classList.add('opacity-50', 'grayscale');
            } else {
                inputContainer.classList.remove('opacity-50', 'grayscale');
            }
        }

        // New handler for typing
        window.handleManualInput = function() {
            if (HAS_SUBMITTED) return;
            
            // Timer logic same as sliders
            if (!IS_CREATING && GAME_MODE !== 'ATTACK' && GAME_MODE !== 'ZEN') {
                if (!startTime) {
                    startTime = Date.now();
                    const timerDisplay = document.getElementById('timer-display');
                    timerDisplay.classList.remove('text-gray-400');
                    timerDisplay.classList.add('text-indigo-900');
                    
                    timerInterval = setInterval(() => {
                        const now = Date.now();
                        timeTaken = ((now - startTime) / 1000).toFixed(1);
                        document.getElementById('timer-display').textContent = timeTaken + "s";
                    }, 100);
                }
            }
        }

        window.handleInput = function(channel) {
            if (HAS_SUBMITTED) return;
            
            if (!IS_CREATING && GAME_MODE !== 'ATTACK' && GAME_MODE !== 'ZEN') {
                if (!startTime) {
                    startTime = Date.now();
                    const timerDisplay = document.getElementById('timer-display');
                    timerDisplay.classList.remove('text-gray-400');
                    timerDisplay.classList.add('text-indigo-900');
                    
                    timerInterval = setInterval(() => {
                        const now = Date.now();
                        timeTaken = ((now - startTime) / 1000).toFixed(1);
                        document.getElementById('timer-display').textContent = timeTaken + "s";
                    }, 100);
                }
            }
            
            if (navigator.vibrate) navigator.vibrate(5);
            updateColor();
        }

        window.updateColor = function() {
            const r = parseInt(document.getElementById('slider-r').value);
            const g = parseInt(document.getElementById('slider-g').value);
            const b = parseInt(document.getElementById('slider-b').value);

            document.getElementById('value-r').textContent = r;
            document.getElementById('value-g').textContent = g;
            document.getElementById('value-b').textContent = b;

            const userColor = `rgb(${r}, ${g}, ${b})`;
            const display = document.getElementById('main-color-display');
            
            if ((GAME_MODE === 'HARDCORE' || GAME_MODE === 'IMPOSSIBLE') && !HAS_SUBMITTED && !IS_CREATING) {
                display.style.backgroundColor = '#f3f4f6'; 
            } else if (GAME_MODE === 'ZEN') {
                const targetColor = `rgb(${TARGET_COLOR.r}, ${TARGET_COLOR.g}, ${TARGET_COLOR.b})`;
                display.style.background = `linear-gradient(to right, ${targetColor} 50%, ${userColor} 50%)`;
            } else {
                display.style.background = ''; // clear gradient if any
                display.style.backgroundColor = userColor;
            }
        }

        window.hideResultModal = function() {
            const modal = document.getElementById('result-modal');
            const content = document.getElementById('result-content');
            
            // --- LOGIC UPDATE START ---
            if (GAME_MODE === 'HARDCORE') {
                // Generate NEW color and restart sequence
                TARGET_COLOR = getRandomColor();
                setupGameUI(); // Resets sliders, timer, and flags
                startMemoryFade(); // Starts the 5s peek
            } else {
                // Impossible Mode: Just reset submission state to allow re-guessing same color
                HAS_SUBMITTED = false;
                updateColor(); // Ensures target is hidden again (gray)
                
                // Re-enable button for Impossible mode specifically since setupGameUI isn't called
                const submitBtn = document.getElementById('submit-button');
                submitBtn.disabled = false;
                submitBtn.querySelector('span').textContent = "Reveal Result";
            }
            // --- LOGIC UPDATE END ---

            // Close animation
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        window.calculateScore = function() {
            if (HAS_SUBMITTED) return;
            HAS_SUBMITTED = true;
            
            if(timerInterval) clearInterval(timerInterval);
            
            if (!startTime) timeTaken = 0.0;
            const floatTime = parseFloat(timeTaken);

            if (GAME_MODE !== 'ZEN') {
                updateColor(); 
            }

            document.getElementById('target-overlay').classList.add('hidden');
            
            let userR, userG, userB;
            
            if (GAME_MODE === 'IMPOSSIBLE') {
                userR = parseInt(document.getElementById('input-r').value) || 0;
                userG = parseInt(document.getElementById('input-g').value) || 0;
                userB = parseInt(document.getElementById('input-b').value) || 0;
            } else {
                userR = parseInt(document.getElementById('slider-r').value);
                userG = parseInt(document.getElementById('slider-g').value);
                userB = parseInt(document.getElementById('slider-b').value);
            }

            const rawDelta = Math.abs(TARGET_COLOR.r - userR) +
                             Math.abs(TARGET_COLOR.g - userG) +
                             Math.abs(TARGET_COLOR.b - userB);

            CURRENT_ACCURACY = Math.max(0, 100 - Math.floor(rawDelta / 3));

            const baseScore = CURRENT_ACCURACY * 100;
            const timeBonus = Math.max(0, Math.floor((45 - floatTime) * 20));
            finalScore = baseScore + timeBonus;

            // --- MODE SPECIFIC HANDLING ---
            let message = '';
            let title = '';
            let emoji = '';
            
            const countdownContainer = document.getElementById('daily-countdown-container');
            if (GAME_MODE === 'ZEN' || GAME_MODE === 'ATTACK' || GAME_MODE === 'CHALLENGE_PLAYER' || GAME_MODE === 'IMPOSSIBLE') {
                countdownContainer.classList.add('hidden');
            } else {
                countdownContainer.classList.remove('hidden');
            }

            const standardActions = document.getElementById('standard-actions');
            const tryAgainBtn = document.getElementById('modal-try-again-btn');
            const nextLevelBtn = document.getElementById('next-level-btn');

            if (GAME_MODE === 'IMPOSSIBLE') {
                impossibleGuesses++;
                
                if (rawDelta === 0) {
                    // WIN
                    title = "UNLOCKED!";
                    message = `Code cracked in ${impossibleGuesses} attempts.`;
                    emoji = "ðŸ”“";
                    fireConfetti(300);
                    finalScore = 1000000 - (impossibleGuesses * 1000); // Arbitrary score
                    
                    document.getElementById('score-label').textContent = "Guesses";
                    document.getElementById('score-output').textContent = impossibleGuesses;
                    document.getElementById('accuracy-subtext').textContent = "PERFECT MATCH";
                    document.getElementById('score-detail-text').textContent = "Impossible Completed";
                    
                    // Show Standard Buttons (Share, etc)
                    standardActions.classList.remove('hidden');
                    tryAgainBtn.classList.add('hidden');
                    
                    // Hide Comparison Visuals as per request? No, keep them to verify.
                    document.getElementById('comparison-visuals').classList.remove('hidden');
                    
                } else {
                    // FAIL -> FEEDBACK
                    title = `Attempt #${impossibleGuesses}`;
                    message = "Review the data below and try again.";
                    emoji = "ðŸ•µï¸â€â™‚ï¸";
                    
                    // Build Hints HTML for the big score area
                    let hints = `<div class="flex flex-col gap-2 text-lg font-bold">`;
                    
                    // Red
                    let rHint = "âœ…";
                    if (userR > TARGET_COLOR.r) rHint = "ðŸ”´â¬‡ï¸ Lower Red";
                    if (userR < TARGET_COLOR.r) rHint = "ðŸ”´â¬†ï¸ Raise Red";
                    hints += `<div class="flex justify-between border-b border-gray-100 pb-1"><span>R: ${userR}</span> <span class="text-indigo-600">${rHint}</span></div>`;
                    
                    // Green
                    let gHint = "âœ…";
                    if (userG > TARGET_COLOR.g) gHint = "ðŸŸ¢â¬‡ï¸ Lower Green";
                    if (userG < TARGET_COLOR.g) gHint = "ðŸŸ¢â¬†ï¸ Raise Green";
                    hints += `<div class="flex justify-between border-b border-gray-100 pb-1"><span>G: ${userG}</span> <span class="text-indigo-600">${gHint}</span></div>`;
                    
                    // Blue
                    let bHint = "âœ…";
                    if (userB > TARGET_COLOR.b) bHint = "ðŸ”µâ¬‡ï¸ Lower Blue";
                    if (userB < TARGET_COLOR.b) bHint = "ðŸ”µâ¬†ï¸ Raise Blue";
                    hints += `<div class="flex justify-between"><span>B: ${userB}</span> <span class="text-indigo-600">${bHint}</span></div>`;
                    
                    hints += `</div>`;
                    
                    document.getElementById('score-label').textContent = "FEEDBACK";
                    document.getElementById('score-output').innerHTML = hints; // Inject HTML
                    document.getElementById('score-output').classList.remove('text-5xl'); // Resize for list
                    document.getElementById('score-output').classList.add('text-xl', 'text-left', 'w-full');
                    
                    document.getElementById('accuracy-subtext').textContent = "";
                    document.getElementById('score-detail-text').textContent = "";
                    
                    // Show Try Again, Hide Standard
                    standardActions.classList.add('hidden');
                    tryAgainBtn.classList.remove('hidden');
                    tryAgainBtn.innerHTML = '<i class="ph-bold ph-arrow-counter-clockwise"></i> Try Again (Keep Guesses)';
                    
                    // Hide visual swatches to focus on data
                    document.getElementById('comparison-visuals').classList.add('hidden');
                }
                
                nextLevelBtn.classList.add('hidden');

            } else if (GAME_MODE === 'ATTACK' || GAME_MODE === 'ZEN') {
                // ... (Existing Logic for Zen/Attack) ...
                document.getElementById('comparison-visuals').classList.remove('hidden');
                document.getElementById('score-output').classList.add('text-5xl');
                document.getElementById('score-output').classList.remove('text-xl', 'text-left', 'w-full');
                tryAgainBtn.classList.add('hidden');
                
                let points = 0;
                if (GAME_MODE === 'ATTACK') points = CURRENT_ACCURACY * 10;
                else points = CURRENT_ACCURACY; 
                
                sessionScore += points;
                document.getElementById('session-score-value').textContent = sessionScore.toLocaleString();

                if (GAME_MODE === 'ATTACK') {
                    if (CURRENT_ACCURACY >= 90) {
                        attackTimeLeft += 5;
                        message = "+5 Seconds! Keep going!";
                        fireConfetti(50);
                    } else {
                        message = "Go faster!";
                    }
                    title = "Round Complete";
                    
                    document.getElementById('score-label').textContent = "Run Score";
                    document.getElementById('score-output').textContent = sessionScore.toLocaleString();
                    document.getElementById('score-detail-text').textContent = `This Round: ${CURRENT_ACCURACY}%`;
                    
                    document.getElementById('standard-actions').classList.add('hidden');
                    document.getElementById('next-level-btn').classList.remove('hidden');
                    document.getElementById('next-level-btn').textContent = "Next Color (+0s)";
                    if (CURRENT_ACCURACY >= 90) document.getElementById('next-level-btn').textContent = "Next Color (+5s)";
                } else {
                    // ZEN MODE RESULT
                    title = "Peaceful Match";
                    message = "Nice mix. Ready for the next one?";
                    if (CURRENT_ACCURACY > 90) fireConfetti(50);
                    
                    document.getElementById('score-label').textContent = "Accuracy";
                    document.getElementById('score-output').textContent = CURRENT_ACCURACY + "%";
                    document.getElementById('score-detail-text').textContent = `Session Total: ${sessionScore}`;
                    document.getElementById('accuracy-subtext').textContent = ""; 
                    
                    document.getElementById('standard-actions').classList.add('hidden');
                    document.getElementById('next-level-btn').classList.remove('hidden');
                    document.getElementById('next-level-btn').textContent = "Next Color";
                }

            } else {
                // ... (Existing Logic for Daily/Hardcore) ...
                document.getElementById('comparison-visuals').classList.remove('hidden');
                document.getElementById('score-output').classList.add('text-5xl');
                document.getElementById('score-output').classList.remove('text-xl', 'text-left', 'w-full');
                
                if (CURRENT_ACCURACY === 100) { title = "PERFECT!"; message = "Pixel perfect matching!"; emoji = "ðŸ¤¯"; fireConfetti(150); }
                else if (CURRENT_ACCURACY >= 95) { title = "Amazing!"; message = "Incredible accuracy."; emoji = "ðŸ”¥"; fireConfetti(100); }
                else if (CURRENT_ACCURACY >= 80) { title = "Great Job!"; message = "You're definitely in the zone."; emoji = "ðŸŽ¨"; fireConfetti(50); }
                else if (CURRENT_ACCURACY >= 60) { title = "Not Bad"; message = "You got the vibe right."; emoji = "ðŸ‘"; }
                else { title = "Oof!"; message = "Memory fade? Try again."; emoji = "ðŸ‘“"; }

                document.getElementById('score-label').textContent = "Total Score";
                document.getElementById('score-output').textContent = finalScore.toLocaleString();
                document.getElementById('accuracy-subtext').textContent = `Accuracy: ${CURRENT_ACCURACY}% | Time Bonus: +${timeBonus}`;
                document.getElementById('score-detail-text').textContent = "(Speed + Accuracy)";
                
                document.getElementById('standard-actions').classList.remove('hidden');
                document.getElementById('next-level-btn').classList.add('hidden');
                
                // ADDED LOGIC FOR HARDCORE TRY AGAIN
                if (GAME_MODE === 'HARDCORE') {
                    tryAgainBtn.classList.remove('hidden');
                    tryAgainBtn.innerHTML = '<i class="ph-bold ph-arrow-counter-clockwise"></i> Try Again';
                } else {
                    tryAgainBtn.classList.add('hidden');
                }
            }

            if (GAME_MODE !== 'ATTACK' && GAME_MODE !== 'ZEN') {
                document.getElementById('result-title').textContent = title;
                document.getElementById('result-message').textContent = message;
                document.getElementById('result-emoji').textContent = emoji;
            } else {
                document.getElementById('result-title').textContent = title;
                document.getElementById('result-message').textContent = message;
                document.getElementById('result-emoji').textContent = ""; 
            }
            
            const targetColorStr = `rgb(${TARGET_COLOR.r}, ${TARGET_COLOR.g}, ${TARGET_COLOR.b})`;
            const userColorStr = `rgb(${userR}, ${userG}, ${userB})`;
            document.getElementById('modal-target-swatch').style.backgroundColor = targetColorStr;
            document.getElementById('modal-user-swatch').style.backgroundColor = userColorStr;
            document.getElementById('target-rgb-result').textContent = `${TARGET_COLOR.r}, ${TARGET_COLOR.g}, ${TARGET_COLOR.b}`;
            document.getElementById('user-rgb-result').textContent = `${userR}, ${userG}, ${userB}`;
            document.getElementById('time-result').textContent = GAME_MODE === 'ATTACK' ? `${attackTimeLeft}s left` : (timeTaken + "s");

            const challengeCreatorActions = document.getElementById('challenge-creator-actions');
            if (GAME_MODE === 'CHALLENGE_CREATOR') {
                document.getElementById('standard-actions').classList.add('hidden');
                challengeCreatorActions.classList.remove('hidden');
            } else {
                challengeCreatorActions.classList.add('hidden');
            }

            const modal = document.getElementById('result-modal');
            const content = document.getElementById('result-content');
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
